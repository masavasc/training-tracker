<script>
function renderChart() {
  const records = JSON.parse(localStorage.getItem('trainingRecords') || '[]')
    .sort((a, b) => new Date(a.date) - new Date(b.date));
  chart.innerHTML = '';
  const wrapper = document.createElement('div');
  wrapper.className = 'bar-wrapper';

  const yAxis = document.createElement('div');
  yAxis.className = 'y-axis';
  for (let i = 80; i >= 50; i -= 5) {
    const label = document.createElement('div');
    label.textContent = i + 'kg';
    yAxis.appendChild(label);
  }
  chart.appendChild(yAxis);

  const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
  svg.setAttribute('class', 'weight-line');
  svg.setAttribute('width', records.length * 32);
  svg.setAttribute('height', '200');
  chart.appendChild(svg);

  const points = [];
  let prevWeight = null;
  records.forEach((rec, idx) => {
    const col = document.createElement('div');
    col.className = 'bar-column';
    col.innerHTML = `<div>${rec.date.split('-')[2]}</div>`;
    if (rec.items) {
      rec.items.forEach(item => {
        const block = document.createElement('div');
        block.className = 'block ' + getCategory(item);
        col.appendChild(block);
      });
    }
    let weight = prevWeight;
    if (rec.weight) {
      weight = parseFloat(rec.weight);
      prevWeight = weight;
    }
    if (weight !== null) {
      const y = 200 - ((weight - 50) / 30) * 200;
      const point = document.createElement('div');
      point.className = 'weight-point';
      point.textContent = weight + 'kg';
      point.style.bottom = y + 'px';
      col.appendChild(point);
      points.push({ x: idx * 32 + 10, y });
    }
    col.onclick = () => showEditDelete(rec.date);
    wrapper.appendChild(col);
  });

  for (let i = 0; i < points.length - 1; i++) {
    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
    line.setAttribute('x1', points[i].x);
    line.setAttribute('y1', points[i].y);
    line.setAttribute('x2', points[i + 1].x);
    line.setAttribute('y2', points[i + 1].y);
    line.setAttribute('stroke', 'navy');
    line.setAttribute('stroke-width', '2');
    svg.appendChild(line);
  }
  chart.appendChild(wrapper);
}

function showEditDelete(date) {
  const records = JSON.parse(localStorage.getItem('trainingRecords') || '[]');
  const matched = records.filter(r => r.date === date);
  if (matched.length === 0) return;
  const win = window.open('', '_blank');
  win.document.write(`<h2>${date} の記録</h2>`);
  matched.forEach((m, index) => {
    win.document.write('<ul>' + m.items.map(i => `<li>${i}</li>`).join('') + '</ul>');
    if (m.weight) win.document.write(`<p><strong>${m.weight}kg</strong></p>`);
    if (m.note) win.document.write(`<p><em>${m.note}</em></p>`);
    win.document.write(
      `<button onclick="window.opener.editRecord('${date}', ${index});window.close();">修正</button> ` +
      `<button onclick="window.opener.deleteRecord('${date}', ${index});window.close();">削除</button>`
    );
    win.document.write('<hr>');
  });
}

function editRecord(date, index) {
  const records = JSON.parse(localStorage.getItem('trainingRecords') || '[]');
  const matched = records.filter(r => r.date === date);
  const target = matched[index];
  if (!target) return;
  dateInput.value = target.date;
  weightInput.value = target.weight || '';
  noteInput.value = target.note || '';
  selectedExercises = [...target.items];
  document.querySelectorAll('.exercise-label').forEach(el => {
    el.classList.remove('selected', 'muscle', 'cardio');
    if (selectedExercises.includes(el.textContent)) {
      el.classList.add('selected');
      const cat = getCategory(el.textContent);
      el.classList.add(cat === '筋トレ' ? 'muscle' : cat === '有酸素' ? 'cardio' : '');
    }
  });
  deleteRecord(date, index);
}

function deleteRecord(date, index) {
  let records = JSON.parse(localStorage.getItem('trainingRecords') || '[]');
  const filtered = records.filter((r, i) => {
    if (r.date !== date) return true;
    const sameDate = records.filter(x => x.date === date);
    return !(sameDate.indexOf(r) === index);
  });
  localStorage.setItem('trainingRecords', JSON.stringify(filtered));
  renderChart();
}
</script>
