// 変更点のみ記述します
let currentYear = new Date().getFullYear();
let currentMonth = new Date().getMonth();

function changeMonth(offset) {
  currentMonth += offset;
  if (currentMonth < 0) {
    currentMonth = 11;
    currentYear--;
  } else if (currentMonth > 11) {
    currentMonth = 0;
    currentYear++;
  }
  renderCalendar();
}

function renderCalendar() {
  const records = JSON.parse(localStorage.getItem('trainingRecords') || '[]');
  calendarTitle.textContent = `${currentYear}年${currentMonth + 1}月`;
  const firstDay = new Date(currentYear, currentMonth, 1);
  const lastDay = new Date(currentYear, currentMonth + 1, 0);
  calendarDiv.innerHTML = '';
  for (let i = 0; i < firstDay.getDay(); i++) {
    calendarDiv.appendChild(document.createElement('div'));
  }
  for (let d = 1; d <= lastDay.getDate(); d++) {
    const dateStr = `${currentYear}-${(currentMonth + 1).toString().padStart(2, '0')}-${d.toString().padStart(2, '0')}`;
    const matched = records.filter(r => r.date === dateStr);
    const dayDiv = document.createElement('div');
    dayDiv.className = 'day';
    dayDiv.textContent = d;
    if (matched.length > 0) {
      const dotsDiv = document.createElement('div');
      dotsDiv.className = 'dots';
      matched.forEach(m => {
        m.items.forEach(item => {
          const cat = getCategory(item);
          const dot = document.createElement('div');
          dot.className = 'dot ' + cat;
          dotsDiv.appendChild(dot);
        });
      });
      dayDiv.appendChild(dotsDiv);
      dayDiv.onclick = () => {
        const win = window.open('', '_blank');
        win.document.write(`<h2>${dateStr} の記録</h2>`);
        matched.forEach(m => {
          win.document.write('<ul>' + m.items.map(i => `<li>${i}</li>`).join('') + '</ul>');
          if (m.note) win.document.write(`<p><em>${m.note}</em></p>`);
          win.document.write('<hr>');
        });
      };
    }
    calendarDiv.appendChild(dayDiv);
  }
}

// カレンダータイトル周辺にナビゲーションボタンを挿入
const calendarTitleDiv = document.getElementById('calendarTitle');
const navDiv = document.createElement('div');
navDiv.style.textAlign = 'center';
navDiv.style.marginBottom = '0.5rem';
navDiv.innerHTML = '<button onclick="changeMonth(-1)">⬅ 前月</button> <span id="calendarTitle"></span> <button onclick="changeMonth(1)">次月 ➡</button>';
calendarTitleDiv.replaceWith(navDiv);
calendarTitle = document.getElementById('calendarTitle');
